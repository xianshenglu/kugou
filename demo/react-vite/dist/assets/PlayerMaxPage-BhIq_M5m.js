import{f as k,d as u,c as B,u as x,j as a,g as R,e as X,a as F}from"./index-C4wcWBJe.js";import{P as H,a as U,N as z,u as D}from"./useNextPrevSong-Be2a9j7z.js";import{u as j}from"./index-Divgcp8q.js";const A="PlayerMax-module__PlayerMax__mask__O5dge",O="PlayerMax-module__PlayerMax__container__78jAB",q="PlayerMax-module__PlayerMax__songName__LaOPN",G="PlayerMax-module__PlayerMax__singerImg__zLqtL",J="PlayerMax-module__PlayerMax__buttonContainer__CH7mY",V="PlayerMax-module__PlayerMax__prevBtn__lEN41",K="PlayerMax-module__PlayerMax__nextBtn__JsiF1",Y="PlayerMax-module__PlayerMax__playBtn__q-uA3",Q="PlayerMax-module__PlayerMax__download__6-SnC",g={PlayerMax__mask:A,PlayerMax__container:O,PlayerMax__songName:q,PlayerMax__singerImg:G,"PlayerMax__singerImg--active":"PlayerMax-module__PlayerMax__singerImg--active__JzhE5",PlayerMax__buttonContainer:J,PlayerMax__prevBtn:V,PlayerMax__nextBtn:K,PlayerMax__playBtn:Y,PlayerMax__download:Q},W="PlayerLyric-module__PlayerLyric__FPEtF",Z="PlayerLyric-module__PlayerLyric_text__TGvUV",w={PlayerLyric:W,PlayerLyric_text:Z,"PlayerLyric_text--active":"PlayerLyric-module__PlayerLyric_text--active__KL5iT"},S=k([e=>e],e=>{const t=e.split(/\n/);return t.pop(),t.map(n=>{const r=n.replace("[","").split("]"),c=r[0],o=c.split(":")[0],s=c.split(":")[1].split(".")[0],l=c.split(":")[1].split(".")[1];return{millisecond:Number(o)*60*1e3+Number(s)*1e3+Number(l),text:r[1].trim().replace(/(男[:：]\s*)|(女[:：]\s*)/,"")}})});function ee(){const[e,t]=u.useState(0),[n,r]=u.useState(!1),{songInfo:{lyric:c},audioElRef:o}=B(),s=x(_=>{r(_)}),l=x(_=>{if(n)return;const M=S(c).map(v=>v.millisecond),d=Math.floor(_.target.currentTime*1e3),E=M.findIndex(v=>v>d*1.005),C=E>1?E-2:0;t(C)});return u.useEffect(()=>{const _=o.current;if(_)return _.addEventListener("timeupdate",l),()=>{_.removeEventListener("timeupdate",l)}},[o,l]),{lyrics:S(c),prevLyricIndex:e,toggleIsTouching:s}}const re=()=>{const{lyrics:e,prevLyricIndex:t,toggleIsTouching:n}=ee(),r=u.useRef([]),c=(o,s)=>(r.current[o]=s,()=>{r.current.splice(o,1)});return u.useEffect(()=>{r.current[t]?.scrollIntoView()},[t]),a.jsx("div",{className:w.PlayerLyric,onTouchStart:()=>n(!0),onTouchEnd:()=>n(!1),children:e.map((o,s)=>a.jsx("p",{ref:l=>c(s,l),className:R(w.PlayerLyric_text,{[w["PlayerLyric_text--active"]]:s===t+1}),children:o.text},s))})},te="PlayerProgress-module__PlayerProgress__zfweH",se="PlayerProgress-module__PlayerProgress__songCurTime__A7-HE",ae="PlayerProgress-module__PlayerProgress__songDuration__Gvntj",ne="PlayerProgress-module__PlayerProgress__progressBar__cjUc4",oe="PlayerProgress-module__PlayerProgress__progressBarPointer__d5hpm",N={PlayerProgress:te,PlayerProgress__songCurTime:se,PlayerProgress__songDuration:ae,PlayerProgress__progressBar:ne,PlayerProgress__progressBarPointer:oe};function I(e){if(isNaN(Number(e)))return"00:00";const t=Math.floor(Number(e)),n=t%60,r=Math.floor(t/60);return String(r).padStart(2,"0")+":"+String(n).padStart(2,"0")}function ce(){const{audioElRef:e}=B(),[t,n]=u.useState(0),[r,c]=u.useState(0),[o,s]=u.useState(0),[l,L]=u.useState(!1),_=u.useRef(null),f=u.useRef(null),M=u.useRef(0),d=x((i,P,y)=>{const m=(i-P)/f.current.width;let h;const T=e.current;switch(y){case 0:h=T.duration*m;break;case 1:h=t+T.duration*m;break}return h<0?h=0:h>T.duration&&(h=T.duration),h}),E=x(()=>{const i=e.current;if(i.readyState<2)return;const P=i.buffered.length,y=Math.floor(100*i.buffered.end(P-1)/i.duration);c(y)}),C=x(i=>{if(l)return;const P=e.current,p=i.target.currentTime,m=Math.floor(100*p/P.duration);n(p),s(m)}),v=x(i=>{const P=i.touches[0].clientX,y=d(P,M.current,1),p=e.current,m=Math.floor(100*y/p.duration);n(y),s(m),M.current=P}),b=x(()=>{const i=e.current;L(!1),Number.isNaN(t)||(i.currentTime=t),window.removeEventListener("touchmove",v),window.removeEventListener("touchend",b)}),$=x(i=>{L(!0),f.current||(f.current=_.current.getBoundingClientRect());const P=i.touches[0].clientX,y=d(P,f.current.left,0),p=e.current,m=Math.floor(100*y/p.duration);n(y),s(m),M.current=P,window.addEventListener("touchmove",v),window.addEventListener("touchend",b)});return j("progress",E,{target:()=>e.current}),j("timeupdate",C,{target:()=>e.current}),{audioElRef:e,progressBarRef:_,currentTime:t,loadProgress:r,currentProgress:o,onTouchStart:$}}const le=()=>{const{audioElRef:e,progressBarRef:t,currentTime:n,currentProgress:r,loadProgress:c,onTouchStart:o}=ce(),s=e.current===null?{duration:0}:e.current,l={backgroundImage:`linear-gradient(to right, #2ca2f9 ${r}%, transparent ${r}%),linear-gradient(to right, #6c6b70 ${c}%, transparent ${c}%)`,color:"red"};return a.jsxs("div",{className:N.PlayerProgress,onTouchStart:o,children:[a.jsx("div",{className:N.PlayerProgress__songCurTime,children:I(n)}),a.jsx("div",{className:N.PlayerProgress__progressBar,ref:t,style:l,children:a.jsx("div",{className:N.PlayerProgress__progressBarPointer,style:{left:r+"%"}})}),a.jsx("div",{className:N.PlayerProgress__songDuration,children:I(s.duration)})]})},ie=({songInfo:{song_name:e,author_name:t,img:n},musicStatus:{isPlaying:r,isLoading:c},prevSong:o,nextSong:s})=>{const{togglePlay:l}=B();return a.jsxs(u.Fragment,{children:[a.jsx("div",{className:g.PlayerMax__mask,style:{backgroundImage:`url(${n}),linear-gradient(to right, rgb(48, 67, 82), rgb(215, 210, 204))`}}),a.jsxs("div",{className:g.PlayerMax__container,children:[a.jsx("h6",{className:g.PlayerMax__songName,children:e}),a.jsx("img",{src:n,className:R(g.PlayerMax__singerImg,{[g["PlayerMax__singerImg--active"]]:r}),alt:t}),a.jsx(re,{}),a.jsx(le,{}),a.jsxs("div",{className:g.PlayerMax__buttonContainer,children:[a.jsx(H,{className:g.PlayerMax__prevBtn,prev:o}),a.jsx(U,{className:g.PlayerMax__playBtn,isLoading:c,isPlaying:r,togglePlay:l}),a.jsx(z,{className:g.PlayerMax__nextBtn,next:s})]}),a.jsx("button",{className:g.PlayerMax__download})]})]})},ye=()=>{const e=X(),t=F(),{musicStatus:n,songInfo:r,audioElRef:c,songIndex:o,songList:s,fetchMusicIfNeeded:l}=B();u.useEffect(()=>{const{play_url:M}=r;if(M===""){const d=new URLSearchParams(e.search).get("musicHash");d&&l(d,0,[{hash:d}])}},[e.search,r,l]);const L={musicStatus:n,songInfo:r,audioElRef:c,songIndex:o,songList:s,location:e,navigate:t},{nextSong:_,prevSong:f}=D(s,o);return a.jsx(ie,{...L,nextSong:_,prevSong:f})};export{ye as default};
