import{r as p,u as j,b,j as u,c as F,a as D,d as X}from"./index-CBzj5LHV.js";import{P as U,a as W,N as H,u as q}from"./useNextPrevSong-CC1J_HO9.js";import{u as I}from"./index-C8HgcgJy.js";const V="PlayerMax-module__PlayerMax__mask__O5dge",G="PlayerMax-module__PlayerMax__container__78jAB",J="PlayerMax-module__PlayerMax__songName__LaOPN",K="PlayerMax-module__PlayerMax__singerImg__zLqtL",Y="PlayerMax-module__PlayerMax__buttonContainer__CH7mY",Q="PlayerMax-module__PlayerMax__prevBtn__lEN41",Z="PlayerMax-module__PlayerMax__nextBtn__JsiF1",ee="PlayerMax-module__PlayerMax__playBtn__q-uA3",te="PlayerMax-module__PlayerMax__download__6-SnC",M={PlayerMax__mask:V,PlayerMax__container:G,PlayerMax__songName:J,PlayerMax__singerImg:K,"PlayerMax__singerImg--active":"PlayerMax-module__PlayerMax__singerImg--active__JzhE5",PlayerMax__buttonContainer:Y,PlayerMax__prevBtn:Q,PlayerMax__nextBtn:Z,PlayerMax__playBtn:ee,PlayerMax__download:te},re="PlayerLyric-module__PlayerLyric__FPEtF",se="PlayerLyric-module__PlayerLyric_text__TGvUV",S={PlayerLyric:re,PlayerLyric_text:se,"PlayerLyric_text--active":"PlayerLyric-module__PlayerLyric_text--active__KL5iT"};function ne(e,t=`expected a function, instead received ${typeof e}`){if(typeof e!="function")throw new TypeError(t)}function oe(e,t=`expected an object, instead received ${typeof e}`){if(typeof e!="object")throw new TypeError(t)}function ae(e,t="expected all items to be functions, instead received the following types: "){if(!e.every(n=>typeof n=="function")){const n=e.map(r=>typeof r=="function"?`function ${r.name||"unnamed"}()`:typeof r).join(", ");throw new TypeError(`${t}[${n}]`)}}var B=e=>Array.isArray(e)?e:[e];function ce(e){const t=Array.isArray(e[0])?e[0]:e;return ae(t,"createSelector expects all input-selectors to be functions, but received the following types: "),t}function le(e,t){const n=[],{length:r}=e;for(let c=0;c<r;c++)n.push(e[c].apply(null,t));return n}var ie=class{constructor(e){this.value=e}deref(){return this.value}},ue=typeof WeakRef<"u"?WeakRef:ie,_e=0,k=1;function R(){return{s:_e,v:void 0,o:null,p:null}}function O(e,t={}){let n=R();const{resultEqualityCheck:r}=t;let c,a=0;function o(){let s=n;const{length:x}=arguments;for(let _=0,g=x;_<g;_++){const d=arguments[_];if(typeof d=="function"||typeof d=="object"&&d!==null){let m=s.o;m===null&&(s.o=m=new WeakMap);const P=m.get(d);P===void 0?(s=R(),m.set(d,s)):s=P}else{let m=s.p;m===null&&(s.p=m=new Map);const P=m.get(d);P===void 0?(s=R(),m.set(d,s)):s=P}}const l=s;let i;if(s.s===k)i=s.v;else if(i=e.apply(null,arguments),a++,r){const _=c?.deref?.()??c;_!=null&&r(_,i)&&(i=_,a!==0&&a--),c=typeof i=="object"&&i!==null||typeof i=="function"?new ue(i):i}return l.s=k,l.v=i,i}return o.clearCache=()=>{n=R(),o.resetResultsCount()},o.resultsCount=()=>a,o.resetResultsCount=()=>{a=0},o}function ye(e,...t){const n=typeof e=="function"?{memoize:e,memoizeOptions:t}:e,r=(...c)=>{let a=0,o=0,s,x={},l=c.pop();typeof l=="object"&&(x=l,l=c.pop()),ne(l,`createSelector expects an output function after the inputs, but received: [${typeof l}]`);const i={...n,...x},{memoize:_,memoizeOptions:g=[],argsMemoize:d=O,argsMemoizeOptions:m=[]}=i,P=B(g),L=B(m),T=ce(c),y=_(function(){return a++,l.apply(null,arguments)},...P),f=d(function(){o++;const v=le(T,arguments);return s=y.apply(null,v),s},...L);return Object.assign(f,{resultFunc:l,memoizedResultFunc:y,dependencies:T,dependencyRecomputations:()=>o,resetDependencyRecomputations:()=>{o=0},lastResult:()=>s,recomputations:()=>a,resetRecomputations:()=>{a=0},memoize:_,argsMemoize:d})};return Object.assign(r,{withTypes:()=>r}),r}var A=ye(O),de=Object.assign((e,t=A)=>{oe(e,`createStructuredSelector expects first argument to be an object where each property is a selector, instead received a ${typeof e}`);const n=Object.keys(e),r=n.map(a=>e[a]);return t(r,(...a)=>a.reduce((o,s,x)=>(o[n[x]]=s,o),{}))},{withTypes:()=>de});const $=A([e=>e],e=>{const t=e.split(/\n/);return t.pop(),t.map(n=>{const r=n.replace("[","").split("]"),c=r[0],a=c.split(":")[0],o=c.split(":")[1].split(".")[0],s=c.split(":")[1].split(".")[1];return{millisecond:Number(a)*60*1e3+Number(o)*1e3+Number(s),text:r[1].trim().replace(/(男[:：]\s*)|(女[:：]\s*)/,"")}})});function me(){const[e,t]=p.useState(0),[n,r]=p.useState(!1),{songInfo:{lyric:c},audioElRef:a}=j(),o=b(l=>{r(l)}),s=b(l=>{if(n)return;const _=$(c).map(P=>P.millisecond),g=Math.floor(l.target.currentTime*1e3),d=_.findIndex(P=>P>g*1.005),m=d>1?d-2:0;t(m)});return p.useEffect(()=>{const l=a.current;if(l)return l.addEventListener("timeupdate",s),()=>{l.removeEventListener("timeupdate",s)}},[a,s]),{lyrics:$(c),prevLyricIndex:e,toggleIsTouching:o}}const Pe=()=>{const{lyrics:e,prevLyricIndex:t,toggleIsTouching:n}=me(),r=p.useRef([]),c=(a,o)=>(r.current[a]=o,()=>{r.current.splice(a,1)});return p.useEffect(()=>{r.current[t]?.scrollIntoView()},[t]),u.jsx("div",{className:S.PlayerLyric,"test-id":"player-max-lyrics",onTouchStart:()=>n(!0),onTouchEnd:()=>n(!1),children:e.map((a,o)=>u.jsx("p",{ref:s=>c(o,s),className:F(S.PlayerLyric_text,{[S["PlayerLyric_text--active"]]:o===t+1}),children:a.text},o))})},pe="PlayerProgress-module__PlayerProgress__zfweH",ge="PlayerProgress-module__PlayerProgress__songCurTime__A7-HE",fe="PlayerProgress-module__PlayerProgress__songDuration__Gvntj",xe="PlayerProgress-module__PlayerProgress__progressBar__cjUc4",he="PlayerProgress-module__PlayerProgress__progressBarPointer__d5hpm",E={PlayerProgress:pe,PlayerProgress__songCurTime:ge,PlayerProgress__songDuration:fe,PlayerProgress__progressBar:xe,PlayerProgress__progressBarPointer:he};function z(e){if(isNaN(Number(e)))return"00:00";const t=Math.floor(Number(e)),n=t%60,r=Math.floor(t/60);return String(r).padStart(2,"0")+":"+String(n).padStart(2,"0")}function Me(){const{audioElRef:e}=j(),[t,n]=p.useState(0),[r,c]=p.useState(0),[a,o]=p.useState(0),[s,x]=p.useState(!1),l=p.useRef(null),i=p.useRef(null),_=p.useRef(0),g=b((y,f,h)=>{const N=(y-f)/i.current.width;let w;const C=e.current;switch(h){case 0:w=C.duration*N;break;case 1:w=t+C.duration*N;break}return w<0?w=0:w>C.duration&&(w=C.duration),w}),d=b(()=>{const y=e.current;if(y.readyState<2)return;const f=y.buffered.length,h=Math.floor(100*y.buffered.end(f-1)/y.duration);c(h)}),m=b(y=>{if(s)return;const f=e.current,v=y.target.currentTime,N=Math.floor(100*v/f.duration);n(v),o(N)}),P=b(y=>{const f=y.touches[0].clientX,h=g(f,_.current,1),v=e.current,N=Math.floor(100*h/v.duration);n(h),o(N),_.current=f}),L=b(()=>{const y=e.current;x(!1),Number.isNaN(t)||(y.currentTime=t),window.removeEventListener("touchmove",P),window.removeEventListener("touchend",L)}),T=b(y=>{x(!0),i.current||(i.current=l.current.getBoundingClientRect());const f=y.touches[0].clientX,h=g(f,i.current.left,0),v=e.current,N=Math.floor(100*h/v.duration);n(h),o(N),_.current=f,window.addEventListener("touchmove",P),window.addEventListener("touchend",L)});return I("progress",d,{target:()=>e.current}),I("timeupdate",m,{target:()=>e.current}),{audioElRef:e,progressBarRef:l,currentTime:t,loadProgress:r,currentProgress:a,onTouchStart:T}}const ve=()=>{const{audioElRef:e,progressBarRef:t,currentTime:n,currentProgress:r,loadProgress:c,onTouchStart:a}=Me(),o=e.current===null?{duration:0}:e.current,s={backgroundImage:`linear-gradient(to right, #2ca2f9 ${r}%, transparent ${r}%),linear-gradient(to right, #6c6b70 ${c}%, transparent ${c}%)`,color:"red"};return u.jsxs("div",{className:E.PlayerProgress,"test-id":"player-max-progress",onTouchStart:a,children:[u.jsx("div",{className:E.PlayerProgress__songCurTime,children:z(n)}),u.jsx("div",{className:E.PlayerProgress__progressBar,ref:t,style:s,children:u.jsx("div",{className:E.PlayerProgress__progressBarPointer,style:{left:r+"%"}})}),u.jsx("div",{className:E.PlayerProgress__songDuration,children:z(o.duration)})]})},Ne=({songInfo:{song_name:e,author_name:t,img:n},musicStatus:{isPlaying:r,isLoading:c},prevSong:a,nextSong:o})=>{const{togglePlay:s}=j();return u.jsxs(p.Fragment,{children:[u.jsx("div",{className:M.PlayerMax__mask,style:{backgroundImage:`url(${n}),linear-gradient(to right, rgb(48, 67, 82), rgb(215, 210, 204))`}}),u.jsxs("div",{className:M.PlayerMax__container,"test-id":"player-max",children:[u.jsx("h6",{className:M.PlayerMax__songName,"test-id":"player-max-song-name",children:e}),u.jsx("img",{src:n,className:F(M.PlayerMax__singerImg,{[M["PlayerMax__singerImg--active"]]:r}),alt:t}),u.jsx(Pe,{}),u.jsx(ve,{}),u.jsxs("div",{className:M.PlayerMax__buttonContainer,children:[u.jsx(U,{className:M.PlayerMax__prevBtn,prev:a}),u.jsx(W,{className:M.PlayerMax__playBtn,isLoading:c,isPlaying:r,togglePlay:s}),u.jsx(H,{className:M.PlayerMax__nextBtn,next:o})]}),u.jsx("button",{className:M.PlayerMax__download})]})]})},Le=()=>{const e=D(),t=X(),{musicStatus:n,songInfo:r,audioElRef:c,songIndex:a,songList:o,fetchMusicIfNeeded:s}=j();p.useEffect(()=>{const{play_url:_}=r;if(_===""){const g=new URLSearchParams(e.search).get("musicHash");g&&s(g,0,[{hash:g}])}},[e.search,r,s]);const x={musicStatus:n,songInfo:r,audioElRef:c,songIndex:a,songList:o,location:e,navigate:t},{nextSong:l,prevSong:i}=q(o,a);return u.jsx(Ne,{...x,nextSong:l,prevSong:i})};export{Le as default};
