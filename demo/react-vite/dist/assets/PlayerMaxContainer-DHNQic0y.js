import{a as u,j as r,f as R,H as X,u as j,G as x,b as D,E as U}from"./index-BPa7neEn.js";import{P as V,a as W,N as F,u as H}from"./useNextPrevSong-Bz62cdKD.js";import{u as T}from"./index-DZLq3pIL.js";import{s as S}from"./utils-C5cHsdda.js";const O="PlayerMax-module__PlayerMax__mask__z7UWn",q="PlayerMax-module__PlayerMax__container__rWV1E",z="PlayerMax-module__PlayerMax__songName__2BJPh",A="PlayerMax-module__PlayerMax__singerImg__hQVu5",J="PlayerMax-module__PlayerMax__buttonContainer__yhOqM",Q="PlayerMax-module__PlayerMax__prevBtn__RQgKy",G="PlayerMax-module__PlayerMax__nextBtn__gvZBb",K="PlayerMax-module__PlayerMax__playBtn__-S0Ok",Y="PlayerMax-module__PlayerMax__download__CpeMA",d={PlayerMax__mask:O,PlayerMax__container:q,PlayerMax__songName:z,PlayerMax__singerImg:A,"PlayerMax__singerImg--active":"PlayerMax-module__PlayerMax__singerImg--active__MB9YE",PlayerMax__buttonContainer:J,PlayerMax__prevBtn:Q,PlayerMax__nextBtn:G,PlayerMax__playBtn:K,PlayerMax__download:Y},Z="PlayerLyric-module__PlayerLyric__Vjiyd",ee="PlayerLyric-module__PlayerLyric_text__WcJar",b={PlayerLyric:Z,PlayerLyric_text:ee,"PlayerLyric_text--active":"PlayerLyric-module__PlayerLyric_text--active__kWXfo"},re=({lyrics:e,prevLyricIndex:a,toggleIsTouching:o})=>{const t=u.useRef([]),c=(n,s)=>(t.current[n]=s,()=>{t.current.splice(n,1)});return u.useEffect(()=>{t.current[a]?.scrollIntoView()},[a]),r.jsx("div",{className:b.PlayerLyric,onTouchStart:()=>o(!0),onTouchEnd:()=>o(!1),children:e.map((n,s)=>r.jsx("p",{ref:l=>c(s,l),className:R(b.PlayerLyric_text,{[b["PlayerLyric_text--active"]]:s===a+1}),children:n.text},s))})},I=X([e=>e],e=>{const a=e.split(/\n/);return a.pop(),a.map(o=>{const t=o.replace("[","").split("]"),c=t[0],n=c.split(":")[0],s=c.split(":")[1].split(".")[0],l=c.split(":")[1].split(".")[1];return{millisecond:Number(n)*60*1e3+Number(s)*1e3+Number(l),text:t[1].trim().replace(/(男[:：]\s*)|(女[:：]\s*)/,"")}})}),te=()=>{const[e,a]=u.useState(0),[o,t]=u.useState(!1),{songInfo:{lyric:c},audioElRef:n}=j(),s=x(i=>{t(i)}),l=x(i=>{if(o)return;const g=I(c).map(v=>v.millisecond),w=Math.floor(i.target.currentTime*1e3),B=g.findIndex(v=>v>w*1.005),E=B>1?B-2:0;a(E)});u.useEffect(()=>{const i=n.current;if(i)return i.addEventListener("timeupdate",l),()=>{i.removeEventListener("timeupdate",l)}},[n]);const p={lyrics:I(c),prevLyricIndex:e,toggleIsTouching:s};return r.jsx(re,{...p})},se="PlayerProgress-module__PlayerProgress__6-jfg",ae="PlayerProgress-module__PlayerProgress__songCurTime__t6PNA",ne="PlayerProgress-module__PlayerProgress__songDuration__6puld",oe="PlayerProgress-module__PlayerProgress__progressBar__lvqkw",ce="PlayerProgress-module__PlayerProgress__progressBarPointer__59B8e",N={PlayerProgress:se,PlayerProgress__songCurTime:ae,PlayerProgress__songDuration:ne,PlayerProgress__progressBar:oe,PlayerProgress__progressBarPointer:ce},le=({audioElRef:{current:e},progressBarRef:a,currentTime:o,currentProgress:t,loadProgress:c,onTouchStart:n})=>{const s=e===null?{duration:0}:e,l={backgroundImage:`linear-gradient(to right, #2ca2f9 ${t}%, transparent ${t}%),linear-gradient(to right, #6c6b70 ${c}%, transparent ${c}%)`,color:"red"};return r.jsxs("div",{className:N.PlayerProgress,onTouchStart:n,children:[r.jsx("div",{className:N.PlayerProgress__songCurTime,children:S(o)}),r.jsx("div",{className:N.PlayerProgress__progressBar,ref:a,style:l,children:r.jsx("div",{className:N.PlayerProgress__progressBarPointer,style:{left:t+"%"}})}),r.jsx("div",{className:N.PlayerProgress__songDuration,children:S(s.duration)})]})},ie=()=>{const{audioElRef:e}=j(),[a,o]=u.useState(0),[t,c]=u.useState(0),[n,s]=u.useState(0),[l,L]=u.useState(!1),p=u.useRef(null),i=u.useRef(null),h=u.useRef(0),g=x((_,P,y)=>{const m=(_-P)/i.current.width;let M;const C=e.current;switch(y){case 0:M=C.duration*m;break;case 1:M=a+C.duration*m;break}return M<0?M=0:M>C.duration&&(M=C.duration),M}),w=x(()=>{const _=e.current;if(_.readyState<2)return;const P=_.buffered.length,y=Math.floor(100*_.buffered.end(P-1)/_.duration);c(y)}),B=x(_=>{if(l)return;const P=e.current,f=_.target.currentTime,m=Math.floor(100*f/P.duration);o(f),s(m)}),E=x(_=>{const P=_.touches[0].clientX,y=g(P,h.current,1),f=e.current,m=Math.floor(100*y/f.duration);o(y),s(m),h.current=P}),v=x(()=>{const _=e.current;L(!1),Number.isNaN(a)||(_.currentTime=a),window.removeEventListener("touchmove",E),window.removeEventListener("touchend",v)}),k=x(_=>{L(!0),i.current||(i.current=p.current.getBoundingClientRect());const P=_.touches[0].clientX,y=g(P,i.current.left,0),f=e.current,m=Math.floor(100*y/f.duration);o(y),s(m),h.current=P,window.addEventListener("touchmove",E),window.addEventListener("touchend",v)});T("progress",w,{target:()=>e.current}),T("timeupdate",B,{target:()=>e.current});const $={audioElRef:e,currentTime:a,loadProgress:t,currentProgress:n,isTouching:l,onTouchStart:k,progressBarRef:p};return r.jsx(le,{...$})},_e=({songInfo:{song_name:e,author_name:a,img:o},musicStatus:{isPlaying:t,isLoading:c},prevSong:n,nextSong:s})=>{const{togglePlay:l}=j();return r.jsxs(u.Fragment,{children:[r.jsx("div",{className:d.PlayerMax__mask,style:{backgroundImage:`url(${o}),linear-gradient(to right, rgb(48, 67, 82), rgb(215, 210, 204))`}}),r.jsxs("div",{className:d.PlayerMax__container,children:[r.jsx("h6",{className:d.PlayerMax__songName,children:e}),r.jsx("img",{src:o,className:R(d.PlayerMax__singerImg,{[d["PlayerMax__singerImg--active"]]:t}),alt:a}),r.jsx(te,{}),r.jsx(ie,{}),r.jsxs("div",{className:d.PlayerMax__buttonContainer,children:[r.jsx(V,{className:d.PlayerMax__prevBtn,prev:n}),r.jsx(W,{className:d.PlayerMax__playBtn,isLoading:c,isPlaying:t,togglePlay:l}),r.jsx(F,{className:d.PlayerMax__nextBtn,next:s})]}),r.jsx("button",{className:d.PlayerMax__download})]})]})},ge=()=>{const e=D(),a=U(),{musicStatus:o,songInfo:t,audioElRef:c,songIndex:n,songList:s,fetchMusicIfNeeded:l}=j();u.useEffect(()=>{const{play_url:h}=t;if(h===""){const g=new URLSearchParams(e.search).get("musicHash");g&&l(g,0,[{hash:g}])}},[e.search,t,l]);const L={musicStatus:o,songInfo:t,audioElRef:c,songIndex:n,songList:s,location:e,navigate:a},{nextSong:p,prevSong:i}=H(s,n);return r.jsx(_e,{...L,nextSong:p,prevSong:i})};export{ge as default};
